[tox]
envlist = py311,py312,lint,format-check,typecheck,security,test-unit,test-integration
isolated_build = true
skip_missing_interpreters = true

[testenv]
description = Run all tests with pytest
deps =
    pytest>=7.4.0
    pytest-asyncio>=0.21.0
    pytest-cov>=4.1.0
    pytest-xdist>=3.3.1
    testcontainers>=3.7.1
    testcontainers[postgres]>=3.7.1
    testcontainers[redis]>=3.7.1
    testcontainers[mysql]>=3.7.1
    faker>=20.0.0
    factory-boy>=3.3.0
    httpx>=0.25.0
commands_pre =
    pip install -e src/internal_base
    pip install -e src/internal_cache
    pip install -e src/internal_rdbms
    pip install -e src/internal_aws
    pip install -e src/internal_fastapi
commands =
    pytest {posargs:-vv --cov=src --cov-branch --cov-report=term-missing --cov-fail-under=90 --tb=short}

[testenv:test-unit]
description = Run unit tests only (fast, no Docker required)
deps = {[testenv]deps}
commands_pre = {[testenv]commands_pre}
commands =
    pytest tests/unit {posargs:-vv -m unit --tb=short --no-cov}

[testenv:test-integration]
description = Run integration tests only (requires Docker)
deps = {[testenv]deps}
commands_pre = {[testenv]commands_pre}
commands =
    pytest tests/integration {posargs:-vv -m integration --tb=short --no-cov}

[testenv:coverage]
description = Generate comprehensive coverage reports
deps = {[testenv]deps}
commands_pre = {[testenv]commands_pre}
commands =
    pytest --cov=src --cov-branch --cov-report=html --cov-report=xml --cov-report=term-missing --cov-fail-under=90

[testenv:lint]
description = Run ruff linter (check only, no fixes)
deps =
    ruff>=0.1.6
skip_install = true
commands =
    ruff check src tests --output-format=full

[testenv:format-check]
description = Check code formatting with ruff (no changes)
deps =
    ruff>=0.1.6
skip_install = true
commands =
    ruff format --check --diff src tests

[testenv:format]
description = Format code with ruff and apply auto-fixes
deps =
    ruff>=0.1.6
skip_install = true
commands =
    ruff format src tests
    ruff check --fix src tests

[testenv:typecheck]
description = Run mypy type checking
deps =
    mypy>=1.7.0
    types-redis
    types-pyyaml
commands_pre =
    pip install -e src/internal_base
    pip install -e src/internal_cache
    pip install -e src/internal_rdbms
    pip install -e src/internal_aws
    pip install -e src/internal_fastapi
commands =
    mypy src --strict --pretty

[testenv:security]
description = Run security checks with bandit and safety
deps =
    bandit[toml]>=1.7.5
    safety>=2.3.0
skip_install = true
commands =
    bandit -r src -c pyproject.toml
    safety check --json

[testenv:docs]
description = Build documentation (if sphinx is setup)
deps =
    sphinx>=7.0.0
    sphinx-rtd-theme>=2.0.0
skip_install = false
commands_pre = {[testenv]commands_pre}
commands =
    sphinx-build -W -b html docs docs/_build/html

[testenv:clean]
description = Clean up build artifacts and caches
deps =
skip_install = true
allowlist_externals =
    rm
    find
commands =
    rm -rf .tox
    rm -rf .pytest_cache
    rm -rf .mypy_cache
    rm -rf .ruff_cache
    rm -rf htmlcov
    rm -rf .coverage
    rm -rf coverage.xml
    find . -type d -name "__pycache__" -exec rm -rf {} +
    find . -type d -name "*.egg-info" -exec rm -rf {} +
    find . -type f -name "*.pyc" -delete
    find . -type f -name "*.pyo" -delete

[testenv:build]
description = Build distribution packages
deps =
    build>=1.0.0
    twine>=4.0.0
skip_install = true
commands =
    python -m build
    twine check dist/*

[testenv:dev]
description = Create development environment with all packages
deps = {[testenv]deps}
commands_pre = {[testenv]commands_pre}
commands =
    python -c "print('Development environment ready!')"
